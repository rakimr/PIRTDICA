{% extends "base.html" %}

{% block title %}Your Entry - PIRTDICA{% endblock %}

{% block content %}
<div class="entry-page">
    <h1>Your Entry</h1>
    
    {% if is_live %}
    <div class="live-banner" id="live-banner">
        <div class="live-indicator">
            <span class="live-dot"></span> LIVE
        </div>
        <p id="live-status-text">Live scores update every 30 seconds</p>
    </div>
    {% elif entry.contest.status == 'completed' %}
    <div class="result-banner {% if entry.beat_house %}win{% else %}loss{% endif %}">
        {% if entry.beat_house %}
            <h2>You Beat the House!</h2>
            <p>You earned {{ entry.coins_earned }} coins!</p>
        {% else %}
            <h2>House Wins</h2>
            <p>Better luck next time!</p>
        {% endif %}
    </div>
    {% else %}
    <div class="pending-banner">
        <h2>Games Haven't Started Yet</h2>
        <p>Check back once games begin for live scoring!</p>
    </div>
    {% endif %}
    
    <div class="entry-comparison" id="entry-comparison">
        <div class="lineup-side your-side">
            <h2>Your Lineup</h2>
            <div class="score-summary">
                <span class="proj">Projected: {{ "%.1f"|format(entry.proj_score) }} FP</span>
                {% if entry.contest.status == 'completed' %}
                <span class="actual">Actual: {{ "%.1f"|format(entry.actual_score) }} FP</span>
                {% elif is_live %}
                <span class="actual live-score" id="your-live-total">Live: -- FP</span>
                {% endif %}
            </div>
            <table class="lineup-table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Salary</th>
                        {% if entry.contest.status == 'completed' %}
                        <th>Proj</th>
                        <th>Actual</th>
                        {% elif is_live %}
                        <th>Proj</th>
                        <th>Live</th>
                        {% else %}
                        <th>Proj</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="your-players">
                    {% for p in players %}
                    {% set team = p.team|default('') %}
                    {% set game_started = team in locked_teams %}
                    <tr class="{% if is_live and not game_started %}game-pending{% endif %}" 
                        data-team="{{ team }}"
                        data-game-time="{{ team_game_times.get(team, '') }}">
                        <td>
                            {% if is_live and not game_started %}
                            <span class="hidden-player">{{ p.position }} - Upcoming</span>
                            {% else %}
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <img src="{{ headshots.get(p.player_name, '') }}" alt="" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #e5e7eb; flex-shrink: 0;" onerror="this.style.display='none'">
                                <span>{{ p.player_name }}</span>
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ team }}</td>
                        <td>
                            {% if is_live and not game_started %}
                            --
                            {% else %}
                            ${{ "{:,}".format(p.salary) }}
                            {% endif %}
                        </td>
                        {% if entry.contest.status == 'completed' %}
                        <td>{{ "%.1f"|format(p.proj_fp) }}</td>
                        <td class="{% if p.actual_fp > p.proj_fp %}positive{% else %}negative{% endif %}">
                            {{ "%.1f"|format(p.actual_fp) }}
                        </td>
                        {% elif is_live %}
                        <td>
                            {% if game_started %}{{ "%.1f"|format(p.proj_fp) }}{% else %}--{% endif %}
                        </td>
                        <td class="live-fp" data-player="{{ p.player_name }}">
                            {% if game_started %}--{% else %}<span class="game-time-label">{{ team_game_times.get(team, '') }}</span>{% endif %}
                        </td>
                        {% else %}
                        <td>{{ "%.1f"|format(p.proj_fp) }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="vs-divider">
            <span>VS</span>
        </div>
        
        <div class="lineup-side house-side">
            <h2>House Lineup</h2>
            <div class="score-summary">
                <span class="proj">Projected: {{ "%.1f"|format(house_total) }} FP</span>
                {% if entry.contest.status == 'completed' %}
                <span class="actual">Actual: {{ "%.1f"|format(entry.house_actual_score or entry.contest.house_lineup_score) }} FP</span>
                {% elif is_live %}
                <span class="actual live-score" id="house-live-total">Live: -- FP</span>
                {% endif %}
            </div>
            <table class="lineup-table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Salary</th>
                        {% if entry.contest.status == 'completed' %}
                        <th>Proj</th>
                        <th>Actual</th>
                        {% elif is_live %}
                        <th>Proj</th>
                        <th>Live</th>
                        {% else %}
                        <th>Proj</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody id="house-players">
                    {% for p in house_players %}
                    {% if p is mapping %}
                        {% set team = p.team|default('') %}
                    {% else %}
                        {% set team = p.team|default('') %}
                    {% endif %}
                    {% set game_started = team in locked_teams %}
                    <tr class="{% if is_live and not game_started %}game-pending{% endif %}"
                        data-team="{{ team }}"
                        data-game-time="{{ team_game_times.get(team, '') }}">
                        <td>
                            {% if is_live and not game_started %}
                            <span class="hidden-player">{{ (p.position if p is mapping else p.position) }} - Upcoming</span>
                            {% else %}
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <img src="{{ headshots.get(p.player_name if p is mapping else p.player_name, '') }}" alt="" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; background: #e5e7eb; flex-shrink: 0;" onerror="this.style.display='none'">
                                <span>{{ p.player_name if p is mapping else p.player_name }}</span>
                            </div>
                            {% endif %}
                        </td>
                        <td>{{ team }}</td>
                        <td>
                            {% if is_live and not game_started %}
                            --
                            {% else %}
                            ${{ "{:,}".format((p.salary if p is mapping else p.salary)|int) }}
                            {% endif %}
                        </td>
                        {% if entry.contest.status == 'completed' %}
                        <td>{{ "%.1f"|format(p.proj_fp if p is mapping else p.proj_fp) }}</td>
                        <td>--</td>
                        {% elif is_live %}
                        <td>
                            {% if game_started %}{{ "%.1f"|format(p.proj_fp if p is mapping else p.proj_fp) }}{% else %}--{% endif %}
                        </td>
                        <td class="live-fp" data-player="{{ p.player_name if p is mapping else p.player_name }}">
                            {% if game_started %}--{% else %}<span class="game-time-label">{{ team_game_times.get(team, '') }}</span>{% endif %}
                        </td>
                        {% else %}
                        <td>{{ "%.1f"|format(p.proj_fp if p is mapping else p.proj_fp) }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="entry-actions">
        <a href="/" class="btn btn-secondary">Back to Home</a>
        <a href="/leaderboard" class="btn btn-secondary">View Leaderboard</a>
    </div>
</div>

{% if is_live %}
<style>
.live-score {
    color: #00ff88;
    font-weight: bold;
}
.live-fp {
    font-weight: bold;
    transition: color 0.3s ease;
}
.live-fp.updated {
    color: #00ff88;
}
.live-banner {
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
    border: 1px solid #333;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin: 20px 0;
    position: relative;
}
.live-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(255, 0, 0, 0.15);
    border: 1px solid rgba(255, 0, 0, 0.3);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: bold;
    color: #ff4444;
    margin-bottom: 8px;
}
.live-dot {
    width: 8px;
    height: 8px;
    background: #ff4444;
    border-radius: 50%;
    animation: pulse 1.5s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
.live-winning .your-side h2 { color: #00ff88; }
.live-losing .your-side h2 { color: #ff4444; }
.game-pending {
    opacity: 0.4;
}
.game-pending td {
    font-style: italic;
}
.hidden-player {
    color: #888;
    font-style: italic;
}
.game-time-label {
    color: #888;
    font-size: 0.85em;
}
</style>
<script>
const ENTRY_ID = {{ entry.id }};
let refreshInterval;

async function fetchLiveScores() {
    try {
        const resp = await fetch(`/api/live-entry/${ENTRY_ID}`);
        const data = await resp.json();
        
        if (data.error) return;
        
        data.your_players.forEach(p => {
            const cells = document.querySelectorAll('#your-players .live-fp');
            cells.forEach(cell => {
                if (cell.dataset.player === p.player_name) {
                    if (p.game_started) {
                        const oldVal = cell.textContent;
                        const newVal = p.live_fp.toFixed(1);
                        cell.textContent = newVal;
                        if (oldVal !== newVal && oldVal !== '--') {
                            cell.classList.add('updated');
                            setTimeout(() => cell.classList.remove('updated'), 2000);
                        }
                        if (p.live_fp > p.proj_fp) {
                            cell.classList.add('positive');
                            cell.classList.remove('negative');
                        } else if (p.live_fp > 0) {
                            cell.classList.add('negative');
                            cell.classList.remove('positive');
                        }
                        const row = cell.closest('tr');
                        if (row && row.classList.contains('game-pending')) {
                            row.classList.remove('game-pending');
                            const nameCell = row.querySelector('td:first-child');
                            if (nameCell) nameCell.textContent = p.player_name;
                            const salaryCell = row.querySelectorAll('td')[2];
                            if (salaryCell) salaryCell.textContent = '$' + p.salary.toLocaleString();
                            const projCell = row.querySelectorAll('td')[3];
                            if (projCell) projCell.textContent = p.proj_fp.toFixed(1);
                        }
                    }
                }
            });
        });
        
        data.house_players.forEach(p => {
            const cells = document.querySelectorAll('#house-players .live-fp');
            cells.forEach(cell => {
                if (cell.dataset.player === p.player_name) {
                    if (p.game_started) {
                        cell.textContent = p.live_fp.toFixed(1);
                        const row = cell.closest('tr');
                        if (row && row.classList.contains('game-pending')) {
                            row.classList.remove('game-pending');
                            const nameCell = row.querySelector('td:first-child');
                            if (nameCell) nameCell.textContent = p.player_name;
                            const salaryCell = row.querySelectorAll('td')[2];
                            if (salaryCell) salaryCell.textContent = '$' + p.salary.toLocaleString();
                            const projCell = row.querySelectorAll('td')[3];
                            if (projCell) projCell.textContent = p.proj_fp.toFixed(1);
                        }
                    }
                }
            });
        });
        
        document.getElementById('your-live-total').textContent = `Live: ${data.your_total.toFixed(1)} FP`;
        document.getElementById('house-live-total').textContent = `Live: ${data.house_total.toFixed(1)} FP`;
        
        const comparison = document.getElementById('entry-comparison');
        if (data.your_total > data.house_total) {
            comparison.classList.add('live-winning');
            comparison.classList.remove('live-losing');
        } else if (data.house_total > data.your_total) {
            comparison.classList.add('live-losing');
            comparison.classList.remove('live-winning');
        }
        
        if (data.status === 'completed') {
            clearInterval(refreshInterval);
            location.reload();
        }
        
    } catch (e) {
        console.error('Live score fetch error:', e);
    }
}

fetchLiveScores();
refreshInterval = setInterval(fetchLiveScores, 30000);
</script>
{% endif %}
{% endblock %}
