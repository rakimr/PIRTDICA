{% extends "base.html" %}

{% block title %}Trends - PIRTDICA{% endblock %}

{% block content %}
<div class="trends-page">
    <div class="trends-header">
        <div>
            <h1 class="page-title">PIRTDICA TRENDS</h1>
            <p class="page-subtitle">Data-driven analysis for today's slate</p>
        </div>
        <form action="/trends/refresh" method="post" class="refresh-form">
            <button type="submit" class="btn btn-secondary refresh-btn">
                Refresh Data
            </button>
        </form>
    </div>
    
    <div class="trends-section">
        <h2>Minutes to Fantasy Points</h2>
        <p class="chart-description">Projected minutes vs fantasy points. Bigger bubbles = better value (FP per $1K). Top-right = volume plays.</p>
        <div class="chart-container">
            <img src="/static/images/value_chart.png?v={{ cache_bust }}" alt="Minutes to Fantasy Points" class="trend-chart">
        </div>
    </div>
    
    <div class="trends-section">
        <h2>Risk-Reward Frontier</h2>
        <p class="chart-description">Bottom-right = cash plays, top-left = GPP darts, top-right = slate breakers.</p>
        <div class="chart-container">
            <img src="/static/images/upside_chart.png?v={{ cache_bust }}" alt="Risk-Reward Frontier" class="trend-chart">
        </div>
    </div>
    
    <div class="trends-section">
        <h2>Defense vs Position Matchups</h2>
        <p class="chart-description">Green = soft matchup (target). Red = tough matchup (avoid).</p>
        <div class="chart-container">
            <img src="/static/images/dvp_heatmap.png?v={{ cache_bust }}" alt="DVP Heatmap" class="trend-chart dvp-heatmap">
        </div>
    </div>
    
    {% if top_value %}
    <div class="trends-section">
        <h2>Top Value Plays</h2>
        <div class="value-table">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Salary</th>
                        <th>Proj FP</th>
                        <th>Value</th>
                        <th>Tier</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in top_value %}
                    <tr>
                        <td>{{ player.player_name }}</td>
                        <td>{{ player.team }}</td>
                        <td>${{ "{:,}".format(player.salary|int) }}</td>
                        <td>{{ "%.1f"|format(player.proj_fp) }}</td>
                        <td class="value-cell">{{ "%.2f"|format(player.value) }}</td>
                        <td>{{ player.salary_tier }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if targeted %}
    <div class="trends-section">
        <h2>Targeted Stat Plays</h2>
        <p class="chart-description">Players facing teams that give up extra fantasy points in specific stats. Sorted by FP impact.</p>
        <div class="targeted-table">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Pos</th>
                        <th>vs</th>
                        <th>Stat</th>
                        <th>Avg</th>
                        <th>+FP</th>
                        <th>Matchup Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for play in targeted %}
                    <tr>
                        <td>{{ play.player_name }}</td>
                        <td>{{ play.position }}</td>
                        <td>{{ play.opponent }}</td>
                        <td>{{ play.stat }}</td>
                        <td>{{ play.player_avg }}</td>
                        <td class="edge-cell">+{{ play.extra_fp }}</td>
                        <td class="matchup-note">{{ play.recommendation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if ownership %}
    <div class="trends-section">
        <h2>Projected Ownership</h2>
        <p class="chart-description">Estimated public ownership based on optimizer frequency. Higher % = more chalk.</p>
        <div class="table-controls">
            <input type="text" class="table-search" data-table="ownership-table" placeholder="Search player...">
        </div>
        <div class="ownership-table">
            <table id="ownership-table">
                <thead>
                    <tr>
                        <th data-sortable="text">Player</th>
                        <th data-sortable="text">Team</th>
                        <th data-sortable="number">Salary</th>
                        <th data-sortable="number">Proj FP</th>
                        <th data-sortable="number">pOwn%</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in ownership %}
                    <tr>
                        <td>{{ player.player_name }}</td>
                        <td>{{ player.team }}</td>
                        <td>${{ "{:,}".format(player.salary|int) }}</td>
                        <td>{{ "%.1f"|format(player.proj_fp) }}</td>
                        <td class="{% if player.pown_pct >= 30 %}chalk-high{% elif player.pown_pct >= 15 %}chalk-med{% else %}chalk-low{% endif %}">{{ "%.0f"|format(player.pown_pct) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if props %}
    <div class="trends-section">
        <h2>Prop Recommendations</h2>
        <p class="chart-description">High-volume players with favorable DVP matchups. Only shows stats where player has meaningful averages.</p>
        <div class="table-controls">
            <input type="text" class="table-search" data-table="props-table" placeholder="Search player...">
        </div>
        <div class="props-table">
            <table id="props-table">
                <thead>
                    <tr>
                        <th data-sortable="text">Player</th>
                        <th data-sortable="text">vs</th>
                        <th data-sortable="text">Stat</th>
                        <th data-sortable="number">Avg</th>
                        <th data-sortable="number">Projected</th>
                        <th data-sortable="number">+/-FP</th>
                        <th data-sortable="text">Call</th>
                    </tr>
                </thead>
                <tbody>
                    {% for prop in props %}
                    <tr>
                        <td>{{ prop.player }}</td>
                        <td>{{ prop.opponent }}</td>
                        <td>{{ prop.stat }}</td>
                        <td>{{ prop.player_avg }}</td>
                        <td>{{ prop.adjusted_avg }}</td>
                        <td class="{% if prop.extra_fp > 0 %}fp-positive{% elif prop.extra_fp < 0 %}fp-negative{% else %}fp-neutral{% endif %}">{{ prop.extra_fp }}</td>
                        <td class="{% if prop.recommendation == 'OVER' %}over-cell{% else %}under-cell{% endif %}">{{ prop.recommendation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
