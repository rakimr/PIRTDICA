{% extends "base.html" %}

{% block title %}Chart Gallery - PIRTDICA{% endblock %}

{% block content %}
<div class="trends-page">
    <div class="trends-header">
        <div>
            <h1 class="page-title">CHART GALLERY</h1>
            <p class="page-subtitle">Data-driven analysis for today's slate</p>
        </div>
        <form action="/trends/refresh" method="post" class="refresh-form">
            <button type="submit" class="btn btn-secondary refresh-btn">
                Refresh Data
            </button>
        </form>
    </div>
    
    <div class="trends-section">
        <h2>Usage to Fantasy Points</h2>
        <p class="chart-description">Usage rate vs fantasy points. Bigger bubbles = better value (FP per $1K). Top-right = high-usage stars.</p>
        <div class="chart-container">
            <img src="/static/images/value_chart.png?v={{ cache_bust }}" alt="Usage to Fantasy Points" class="trend-chart">
        </div>
    </div>
    
    <div class="trends-section">
        <h2>Risk-Reward Frontier</h2>
        <p class="chart-description">Bottom-right = cash plays, top-left = GPP darts, top-right = slate breakers.</p>
        <div class="chart-container">
            <img src="/static/images/upside_chart.png?v={{ cache_bust }}" alt="Risk-Reward Frontier" class="trend-chart">
        </div>
    </div>
    
    <div class="trends-section">
        <h2>Referee Foul Tendencies</h2>
        <p class="chart-description">Tonight's crews plotted by foul volume (X) and home/away bias (Y). ▲ = home-favored, ▼ = road-favored.</p>
        <div class="chart-container">
            {% if ref_chart_exists %}
            <img src="/static/images/ref_foul_chart.png?v={{ cache_bust }}" alt="Referee Foul Chart" class="trend-chart">
            {% else %}
            <div style="text-align:center; padding:40px 20px; color:#888; font-size:1.1rem;">
                Referee assignments for tonight's games haven't been posted yet. Check back closer to tip-off.
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="trends-section">
        <h2>Defense vs Position Matchups</h2>
        <p class="chart-description">Green = soft matchup (target). Red = tough matchup (avoid).</p>
        <div class="chart-container">
            <img src="/static/images/dvp_heatmap.png?v={{ cache_bust }}" alt="DVP Heatmap" class="trend-chart dvp-heatmap">
        </div>
    </div>
    
    {% if top_value %}
    <div class="trends-section">
        <h2>Top Value Plays</h2>
        <div class="value-table">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Team</th>
                        <th>Salary</th>
                        <th>Proj FP</th>
                        <th>Value</th>
                        <th>Tier</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in top_value %}
                    <tr>
                        <td>{{ player.player_name }}</td>
                        <td>{{ player.team }}</td>
                        <td>${{ "{:,}".format(player.salary|int) }}</td>
                        <td>{{ "%.1f"|format(player.proj_fp) }}</td>
                        <td class="value-cell">{{ "%.2f"|format(player.value) }}</td>
                        <td>{{ player.salary_tier }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if targeted %}
    <div class="trends-section">
        <h2>Targeted Stat Plays</h2>
        <p class="chart-description">Players facing teams that give up extra fantasy points in specific stats. Sorted by FP impact.</p>
        <div class="targeted-table">
            <table>
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Pos</th>
                        <th>vs</th>
                        <th>Stat</th>
                        <th>Avg</th>
                        <th>+FP</th>
                        <th>Matchup Note</th>
                    </tr>
                </thead>
                <tbody>
                    {% for play in targeted %}
                    <tr>
                        <td>{{ play.player_name }}</td>
                        <td>{{ play.position }}</td>
                        <td>{{ play.opponent }}</td>
                        <td>{{ play.stat }}</td>
                        <td>{{ play.player_avg }}</td>
                        <td class="edge-cell">+{{ play.extra_fp }}</td>
                        <td class="matchup-note">{{ play.recommendation }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if ownership %}
    <div class="trends-section">
        <h2>Projected Ownership (FanDuel)</h2>
        <p class="chart-description">FTA market ownership vs our Monte Carlo model. Diff = FTA minus Ours (positive = we're underweighting).</p>
        <div class="table-controls">
            <input type="text" class="table-search" data-table="ownership-table" placeholder="Search player...">
        </div>
        <div class="ownership-table">
            <table id="ownership-table">
                <thead>
                    <tr>
                        <th data-sortable="text">Player</th>
                        <th data-sortable="text">Team</th>
                        <th data-sortable="number">FTA Own%</th>
                        <th data-sortable="number">Our Own%</th>
                        <th data-sortable="number">Diff</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in ownership %}
                    {% if p.ownership_pct > 0 or p.our_pown > 0 %}
                    <tr>
                        <td>{{ p.player_name }}</td>
                        <td>{{ p.team }}</td>
                        <td>{{ "%.1f"|format(p.ownership_pct) }}%</td>
                        <td>{{ "%.1f"|format(p.our_pown) }}%</td>
                        <td class="{% if p.diff > 5 %}fp-positive{% elif p.diff < -5 %}fp-negative{% else %}fp-neutral{% endif %}">{{ "%+.1f"|format(p.diff) }}</td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% if props %}
    <div class="trends-section">
        <h2>Prop Recommendations</h2>
        <p class="chart-description">Our projections vs FanDuel book lines. Sorted by largest edge where our model disagrees with the market.</p>
        <div class="table-controls">
            <input type="text" class="table-search" data-table="props-table" placeholder="Search player...">
        </div>
        <div class="props-table">
            <table id="props-table">
                <thead>
                    <tr>
                        <th data-sortable="text">Player</th>
                        <th data-sortable="text">vs</th>
                        <th data-sortable="text">Stat</th>
                        <th data-sortable="number">Avg</th>
                        <th data-sortable="number">Proj</th>
                        <th data-sortable="number">Line</th>
                        <th data-sortable="number">Edge%</th>
                        <th data-sortable="text">Call</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for prop in props %}
                    <tr>
                        <td>{{ prop.player }}</td>
                        <td>{{ prop.opponent }}</td>
                        <td>{{ prop.stat }}</td>
                        <td>{{ prop.player_avg }}</td>
                        <td>{{ prop.adjusted_avg }}</td>
                        <td>{{ prop.book_line if prop.book_line is not none and prop.book_line == prop.book_line else '—' }}</td>
                        <td class="{% if prop.vs_book_edge is not none and prop.vs_book_edge == prop.vs_book_edge %}{% if prop.vs_book_edge > 15 %}fp-positive{% elif prop.vs_book_edge < -15 %}fp-negative{% else %}fp-neutral{% endif %}{% endif %}">{{ '%+.1f'|format(prop.vs_book_edge) if prop.vs_book_edge is not none and prop.vs_book_edge == prop.vs_book_edge else '—' }}</td>
                        <td class="{% if prop.recommendation == 'OVER' %}over-cell{% else %}under-cell{% endif %}">{{ prop.recommendation }}</td>
                        <td class="trend-btn-cell"><button class="trend-analysis-btn" data-player="{{ prop.player }}" data-stat="{{ prop.stat }}" data-line="{{ prop.book_line if prop.book_line is not none and prop.book_line == prop.book_line else '' }}" data-call="{{ prop.recommendation }}" title="View trend">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                        </button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>

<div id="trend-modal" class="trend-modal-overlay" style="display:none;">
    <div class="trend-modal">
        <div class="trend-modal-header">
            <h3 id="trend-modal-title"></h3>
            <button class="trend-modal-close" onclick="closeTrendModal()">&times;</button>
        </div>
        <div class="trend-modal-body">
            <canvas id="trend-chart" height="260"></canvas>
        </div>
        <div class="trend-modal-legend">
            <span class="legend-item"><span class="legend-line legend-blue"></span> FanDuel Line</span>
            <span class="legend-item"><span class="legend-line legend-grey"></span> Player Average</span>
        </div>
        <div class="trend-modal-footer">
            <span id="trend-modal-avg"></span>
            <span id="trend-modal-call"></span>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let trendChart = null;

document.querySelectorAll('.trend-analysis-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const player = this.dataset.player;
        const stat = this.dataset.stat;
        const line = this.dataset.line ? parseFloat(this.dataset.line) : null;
        const call = this.dataset.call;
        openTrendModal(player, stat, line, call);
    });
});

async function openTrendModal(player, stat, line, call) {
    const modal = document.getElementById('trend-modal');
    const title = document.getElementById('trend-modal-title');
    const avgEl = document.getElementById('trend-modal-avg');
    const callEl = document.getElementById('trend-modal-call');
    
    title.textContent = player + ' — ' + stat + ' (Last 10 Games)';
    avgEl.textContent = 'Loading...';
    callEl.textContent = '';
    modal.style.display = 'flex';

    try {
        const res = await fetch('/api/player-trend/' + encodeURIComponent(player) + '/' + encodeURIComponent(stat) + '?n=10');
        const data = await res.json();
        if (data.error && (!data.games || data.games.length === 0)) {
            avgEl.textContent = 'No game log data available.';
            return;
        }
        const labels = data.games.map(g => {
            const m = g.matchup || '';
            const parts = m.split(' ');
            return parts[parts.length - 1] || g.date;
        });
        const values = data.games.map(g => g.value);
        const avg = data.avg;

        avgEl.textContent = '10-Game Avg: ' + avg;
        if (call) {
            callEl.textContent = call;
            callEl.className = call === 'OVER' ? 'trend-call-over' : 'trend-call-under';
        }

        const barColors = values.map(v => {
            if (line !== null) {
                return v >= line ? '#111827' : '#d1d5db';
            }
            return v >= avg ? '#111827' : '#d1d5db';
        });

        const ctx = document.getElementById('trend-chart').getContext('2d');
        if (trendChart) trendChart.destroy();

        const datasets = [{
            label: stat,
            data: values,
            backgroundColor: barColors,
            borderRadius: 4,
            barPercentage: 0.7
        }];

        trendChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: { beginAtZero: true, grid: { color: '#e5e7eb' }, ticks: { font: { family: 'Marvel' } }, title: { display: true, text: stat, font: { family: 'Marvel', size: 13, weight: 'bold' }, color: '#374151' } },
                    x: { grid: { display: false }, ticks: { font: { family: 'Marvel', size: 11 } }, title: { display: true, text: 'Game', font: { family: 'Marvel', size: 13, weight: 'bold' }, color: '#374151' } }
                }
            },
            plugins: [{
                id: 'customLines',
                afterDraw(chart) {
                    const ctx = chart.ctx;
                    const yAxis = chart.scales.y;
                    const xAxis = chart.scales.x;
                    
                    if (line !== null) {
                        const yLine = yAxis.getPixelForValue(line);
                        ctx.save();
                        ctx.strokeStyle = '#2563eb';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([6, 4]);
                        ctx.beginPath();
                        ctx.moveTo(xAxis.left, yLine);
                        ctx.lineTo(xAxis.right, yLine);
                        ctx.stroke();
                        ctx.restore();
                    }
                    
                    const yAvg = yAxis.getPixelForValue(avg);
                    ctx.save();
                    ctx.strokeStyle = '#6b7280';
                    ctx.lineWidth = 1.5;
                    ctx.setLineDash([4, 4]);
                    ctx.beginPath();
                    ctx.moveTo(xAxis.left, yAvg);
                    ctx.lineTo(xAxis.right, yAvg);
                    ctx.stroke();
                    ctx.restore();
                }
            }]
        });
    } catch(e) {
        avgEl.textContent = 'Error loading trend data.';
    }
}

function closeTrendModal() {
    document.getElementById('trend-modal').style.display = 'none';
    if (trendChart) { trendChart.destroy(); trendChart = null; }
}

document.getElementById('trend-modal').addEventListener('click', function(e) {
    if (e.target === this) closeTrendModal();
});
</script>
{% endblock %}
