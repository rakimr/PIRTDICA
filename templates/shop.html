{% extends "base.html" %}

{% block title %}Shop - PIRTDICA{% endblock %}

{% block content %}
<div class="shop-page">
    <div class="shop-header">
        <h1>Coach Shop</h1>
        <p class="balance">Your balance: <strong>{{ user.coins }} coins</strong></p>
    </div>
    
    <div class="pillar-tabs">
        {% for key, pillar in pillars.items() %}
        <button class="pillar-tab {% if key == active_pillar %}active{% endif %}" data-pillar="{{ key }}">
            <span class="pillar-tab-icon">
                {% if key == 'identity' %}&#9733;{% elif key == 'prestige' %}&#9813;{% elif key == 'access' %}&#9881;{% elif key == 'analytics' %}&#9783;{% endif %}
            </span>
            <span class="pillar-tab-label">{{ pillar.label }}</span>
        </button>
        {% endfor %}
    </div>

    {% for key, pillar in pillars.items() %}
    <div class="pillar-panel {% if key == active_pillar %}active{% endif %}" id="pillar-{{ key }}">
        <div class="pillar-intro">
            <p>{{ pillar.description }}</p>
        </div>

        {% if key == 'identity' %}
            <div class="identity-section">
                <h3>Avatars</h3>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'avatar' %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %}"
                         data-category="avatar"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}">
                        <div class="item-preview">
                            <img src="{{ item.item_data }}" alt="{{ item.name }}">
                        </div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        <button type="button" class="btn btn-outline btn-small preview-btn">Preview</button>
                        {% if item.id in owned_ids %}
                            <span class="owned-badge">Owned</span>
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="identity-section">
                <h3>Profile Themes</h3>
                <p class="section-hint">Themes change the look of your entire profile page. Equip one to make your profile stand out.</p>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'theme' %}
                    {% set theme_json = item.item_data|default('{}') %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %} {% if item.code == active_theme_code %}equipped{% endif %}"
                         data-category="theme"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-item-code="{{ item.code or '' }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}"
                         data-equipped="{{ 'true' if item.code == active_theme_code else 'false' }}">
                        <div class="item-preview theme-swatch" id="theme-swatch-{{ item.id }}"></div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        {% if item.is_seasonal %}<span class="seasonal-tag">Limited</span>{% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        {% if item.id in owned_ids %}
                            {% if item.code == active_theme_code %}
                                <span class="equipped-badge">Equipped</span>
                                <form method="POST" action="/shop/unequip/{{ item.id }}">
                                    <button type="submit" class="btn btn-secondary btn-small">Unequip</button>
                                </form>
                            {% else %}
                                <form method="POST" action="/shop/equip/{{ item.id }}">
                                    <button type="submit" class="btn btn-primary btn-small">Equip</button>
                                </form>
                            {% endif %}
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="identity-section">
                <h3>Cosmetic Badges</h3>
                <p class="section-hint">Decorative badges appear on your profile. Equip up to 3 at a time. These are purely cosmetic and never mimic earned achievement badges.</p>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'badge' %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %} {% if item.code in equipped_badge_codes %}equipped{% endif %}"
                         data-category="badge"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-item-code="{{ item.code or '' }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}"
                         data-equipped="{{ 'true' if item.code in equipped_badge_codes else 'false' }}">
                        <div class="item-preview badge-preview-card" id="badge-preview-{{ item.id }}"></div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        {% if item.id in owned_ids %}
                            {% if item.code in equipped_badge_codes %}
                                <span class="equipped-badge">Equipped</span>
                                <form method="POST" action="/shop/unequip/{{ item.id }}">
                                    <button type="submit" class="btn btn-secondary btn-small">Unequip</button>
                                </form>
                            {% else %}
                                <form method="POST" action="/shop/equip/{{ item.id }}">
                                    <button type="submit" class="btn btn-primary btn-small">Equip</button>
                                </form>
                            {% endif %}
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>

        {% elif key == 'prestige' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9813;</div>
                <h3>Prestige is Coming</h3>
                <p>Competitive ranking and progression features are on the way.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>ELO title ranks and ranked ladders</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>High-stakes H2H rooms</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Elite-only contests</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Seasonal Battle Pass with tier progression</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Exclusive cosmetics and profile flairs</span>
                    </div>
                </div>
            </div>

        {% elif key == 'access' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9881;</div>
                <h3>Access is Coming</h3>
                <p>Strategic tools and visualizations that sharpen your edge â€” without breaking competitive integrity.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Advanced matchup visualizations</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Archetype heatmaps</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Opponent scouting reports</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Historical matchup explorer</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Ceiling probability charts</span>
                    </div>
                </div>
            </div>

        {% elif key == 'analytics' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9783;</div>
                <h3>Analytics is Coming</h3>
                <p>Lineup customization features that let you build your way.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom lineup naming</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Save lineup templates</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Advanced optimizer presets</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom projection weight uploads</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom DVS weighting sliders</span>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="shop-preview-overlay" id="previewOverlay">
    <div class="shop-preview-modal">
        <button class="shop-preview-close" id="previewClose">&times;</button>
        <div class="shop-preview-content" id="previewContent"></div>
        <div class="shop-preview-info">
            <h2 id="previewName"></h2>
            <p id="previewDesc"></p>
            <p class="price" id="previewPrice"></p>
            <div id="previewAction"></div>
        </div>
    </div>
</div>

<script>
(function() {
    var username = {{ user.username|tojson }};

    document.querySelectorAll('.shop-item[data-category="theme"]').forEach(function(el) {
        var swatch = el.querySelector('.theme-swatch');
        if (!swatch) return;
        try {
            var d = JSON.parse(el.dataset.itemData);
            swatch.style.background = d.bg || '#1a1a1a';
            swatch.style.borderLeft = '4px solid ' + (d.accent || '#fff');
            swatch.style.position = 'relative';
            swatch.innerHTML = '<span style="position:absolute;top:8px;left:12px;font-size:0.7rem;font-weight:700;color:' + (d.text || '#fff') + ';letter-spacing:0.05em;">THEME</span>' +
                '<span style="position:absolute;bottom:8px;right:12px;width:20px;height:20px;border-radius:50%;background:' + (d.accent || '#fff') + ';box-shadow:0 0 8px ' + (d.glow || 'transparent') + ';"></span>';
        } catch(e) {}
    });

    document.querySelectorAll('.shop-item[data-category="badge"]').forEach(function(el) {
        var preview = el.querySelector('.badge-preview-card');
        if (!preview) return;
        try {
            var d = JSON.parse(el.dataset.itemData);
            if (d.type === 'signature') {
                preview.innerHTML = '<span style="font-weight:700;font-size:1rem;color:' + (d.color || '#1a1a1a') + ';letter-spacing:0.1em;' + (d.animated ? 'animation:pulse-glow 2s ease-in-out infinite;' : '') + '">' + (d.text || '') + '</span>';
            } else if (d.type === 'frame_accent') {
                preview.style.border = '3px solid ' + (d.color || '#D4AF37');
                if (d.animated) preview.style.boxShadow = '0 0 10px ' + (d.color || '#D4AF37');
                preview.innerHTML = '<span style="font-size:0.7rem;color:' + (d.color || '#1a1a1a') + ';font-weight:600;text-transform:uppercase;">' + (d.style || 'accent') + '</span>';
            } else if (d.type === 'divider') {
                preview.innerHTML = '<div style="width:80%;height:2px;background:' + (d.color || '#1a1a1a') + ';margin:auto;border-radius:2px;"></div>';
            } else if (d.type === 'aura') {
                preview.style.boxShadow = '0 0 15px ' + (d.color || '#f97316') + ', 0 0 30px ' + (d.color || '#f97316') + '40';
                preview.innerHTML = '<span style="font-size:0.7rem;color:' + (d.color || '#f97316') + ';font-weight:600;">AURA</span>';
            }
        } catch(e) {}
    });

    document.querySelectorAll('.pillar-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.pillar-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.pillar-panel').forEach(function(p) { p.classList.remove('active'); });
            tab.classList.add('active');
            document.getElementById('pillar-' + tab.dataset.pillar).classList.add('active');
        });
    });

    var overlay = document.getElementById('previewOverlay');
    var content = document.getElementById('previewContent');
    var nameEl = document.getElementById('previewName');
    var descEl = document.getElementById('previewDesc');
    var priceEl = document.getElementById('previewPrice');
    var actionEl = document.getElementById('previewAction');

    function openPreview(el) {
        var d = el.closest('.shop-item').dataset;
        var category = d.category;
        var name = d.name;
        var data = d.itemData;
        var description = d.description;
        var price = d.price;
        var itemId = d.itemId;
        var owned = d.owned === 'true';
        var canAfford = d.canAfford === 'true';

        nameEl.textContent = name;
        descEl.textContent = description;
        priceEl.textContent = price + ' coins';
        content.innerHTML = '';

        if (category === 'avatar') {
            var card = document.createElement('div');
            card.className = 'preview-profile-card';
            var wrap = document.createElement('div');
            wrap.className = 'preview-avatar-wrap';
            var img = document.createElement('img');
            img.src = data;
            img.alt = name;
            wrap.appendChild(img);
            var info = document.createElement('div');
            info.className = 'preview-profile-info';
            var uname = document.createElement('span');
            uname.className = 'preview-username';
            uname.textContent = username;
            var label = document.createElement('span');
            label.className = 'preview-label';
            label.textContent = 'How this avatar looks on your profile';
            info.appendChild(uname);
            info.appendChild(label);
            card.appendChild(wrap);
            card.appendChild(info);
            content.appendChild(card);
        } else if (category === 'theme') {
            var demo = document.createElement('div');
            demo.className = 'preview-theme-demo';
            demo.style.background = data;
            var tcard = document.createElement('div');
            tcard.className = 'preview-theme-card';
            var ttitle = document.createElement('span');
            ttitle.className = 'preview-theme-title';
            ttitle.textContent = 'Your Profile';
            var tsub = document.createElement('span');
            tsub.className = 'preview-theme-sub';
            tsub.textContent = 'Theme applied to your page accent';
            tcard.appendChild(ttitle);
            tcard.appendChild(tsub);
            demo.appendChild(tcard);
            content.appendChild(demo);
        } else if (category === 'badge') {
            var bdemo = document.createElement('div');
            bdemo.className = 'preview-badge-demo';
            var blarge = document.createElement('div');
            blarge.className = 'preview-badge-large';
            blarge.textContent = data;
            bdemo.appendChild(blarge);
            var ctx = document.createElement('div');
            ctx.className = 'preview-badge-context';
            var cu = document.createElement('span');
            cu.className = 'preview-username';
            cu.textContent = username;
            var tag = document.createElement('span');
            tag.className = 'preview-badge-tag';
            tag.textContent = data;
            ctx.appendChild(cu);
            ctx.appendChild(tag);
            bdemo.appendChild(ctx);
            var blabel = document.createElement('span');
            blabel.className = 'preview-label';
            blabel.textContent = 'This badge appears on your profile and leaderboard';
            bdemo.appendChild(blabel);
            content.appendChild(bdemo);
        }

        actionEl.innerHTML = '';
        if (owned) {
            var span = document.createElement('span');
            span.className = 'owned-badge';
            span.textContent = 'You own this';
            actionEl.appendChild(span);
        } else if (canAfford) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/shop/buy/' + itemId;
            var btn = document.createElement('button');
            btn.type = 'submit';
            btn.className = 'btn btn-primary';
            btn.textContent = 'Buy Now';
            form.appendChild(btn);
            actionEl.appendChild(form);
        } else {
            var ins = document.createElement('span');
            ins.className = 'insufficient';
            ins.textContent = 'Not enough coins';
            actionEl.appendChild(ins);
        }

        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closePreview() {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    document.querySelectorAll('.preview-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { openPreview(this); });
    });

    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closePreview();
    });

    document.getElementById('previewClose').addEventListener('click', closePreview);

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closePreview();
    });
})();
</script>
{% endblock %}
