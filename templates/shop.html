{% extends "base.html" %}

{% block title %}Shop - PIRTDICA{% endblock %}

{% block content %}
<div class="shop-page">
    <div class="shop-header">
        <h1>Coach Shop</h1>
        <p class="balance">Your balance: <strong>{{ user.coins }} coins</strong></p>
    </div>
    
    <div class="pillar-tabs">
        {% for key, pillar in pillars.items() %}
        <button class="pillar-tab {% if key == active_pillar %}active{% endif %}" data-pillar="{{ key }}">
            <span class="pillar-tab-icon">
                {% if key == 'identity' %}&#9733;{% elif key == 'prestige' %}&#9813;{% elif key == 'access' %}&#9881;{% elif key == 'analytics' %}&#9783;{% endif %}
            </span>
            <span class="pillar-tab-label">{{ pillar.label }}</span>
        </button>
        {% endfor %}
    </div>

    {% for key, pillar in pillars.items() %}
    <div class="pillar-panel {% if key == active_pillar %}active{% endif %}" id="pillar-{{ key }}">
        <div class="pillar-intro">
            <p>{{ pillar.description }}</p>
        </div>

        {% if key == 'identity' %}
            <div class="identity-section">
                <h3>Avatars</h3>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'avatar' %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %}"
                         data-category="avatar"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}">
                        <div class="item-preview">
                            <img src="{{ item.item_data }}" alt="{{ item.name }}">
                        </div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        <button type="button" class="btn btn-outline btn-small preview-btn">Preview</button>
                        {% if item.id in owned_ids %}
                            <span class="owned-badge">Owned</span>
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="identity-section">
                <h3>Profile Themes</h3>
                <p class="section-hint">Themes change the look of your entire profile page. Equip one to make your profile stand out.</p>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'theme' %}
                    {% set theme_json = item.item_data|default('{}') %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %} {% if item.code == active_theme_code %}equipped{% endif %}"
                         data-category="theme"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-item-code="{{ item.code or '' }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}"
                         data-equipped="{{ 'true' if item.code == active_theme_code else 'false' }}">
                        <div class="item-preview theme-swatch" id="theme-swatch-{{ item.id }}"></div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        {% if item.is_seasonal %}<span class="seasonal-tag">Limited</span>{% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        <button type="button" class="btn btn-outline btn-small preview-btn">Preview</button>
                        {% if item.id in owned_ids %}
                            {% if item.code == active_theme_code %}
                                <span class="equipped-badge">Equipped</span>
                                <form method="POST" action="/shop/unequip/{{ item.id }}">
                                    <button type="submit" class="btn btn-secondary btn-small">Unequip</button>
                                </form>
                            {% else %}
                                <form method="POST" action="/shop/equip/{{ item.id }}">
                                    <button type="submit" class="btn btn-primary btn-small">Equip</button>
                                </form>
                            {% endif %}
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>
            
            <div class="identity-section">
                <h3>Cosmetic Badges</h3>
                <p class="section-hint">Decorative badges appear on your profile. Equip up to 3 at a time. These are purely cosmetic and never mimic earned achievement badges.</p>
                <div class="items-grid">
                    {% for item in pillar.shop_items if item.category == 'badge' %}
                    <div class="shop-item {% if item.id in owned_ids %}owned{% endif %} {% if item.code in equipped_badge_codes %}equipped{% endif %}"
                         data-category="badge"
                         data-name="{{ item.name }}"
                         data-item-data="{{ item.item_data }}"
                         data-description="{{ item.description or '' }}"
                         data-price="{{ item.price }}"
                         data-item-id="{{ item.id }}"
                         data-item-code="{{ item.code or '' }}"
                         data-owned="{{ 'true' if item.id in owned_ids else 'false' }}"
                         data-can-afford="{{ 'true' if user.coins >= item.price else 'false' }}"
                         data-rarity="{{ item.rarity or 'common' }}"
                         data-equipped="{{ 'true' if item.code in equipped_badge_codes else 'false' }}">
                        <div class="item-preview badge-preview-card" id="badge-preview-{{ item.id }}"></div>
                        <h3>{{ item.name }}</h3>
                        {% if item.rarity and item.rarity != 'common' %}
                        <span class="rarity-tag rarity-{{ item.rarity }}">{{ item.rarity }}</span>
                        {% endif %}
                        <p class="description">{{ item.description }}</p>
                        <p class="price">{{ item.price }} coins</p>
                        <button type="button" class="btn btn-outline btn-small preview-btn">Preview</button>
                        {% if item.id in owned_ids %}
                            {% if item.code in equipped_badge_codes %}
                                <span class="equipped-badge">Equipped</span>
                                <form method="POST" action="/shop/unequip/{{ item.id }}">
                                    <button type="submit" class="btn btn-secondary btn-small">Unequip</button>
                                </form>
                            {% else %}
                                <form method="POST" action="/shop/equip/{{ item.id }}">
                                    <button type="submit" class="btn btn-primary btn-small">Equip</button>
                                </form>
                            {% endif %}
                        {% elif user.coins >= item.price %}
                            <form method="POST" action="/shop/buy/{{ item.id }}">
                                <button type="submit" class="btn btn-primary btn-small">Buy</button>
                            </form>
                        {% else %}
                            <span class="insufficient">Not enough coins</span>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="no-items">Coming soon!</p>
                    {% endfor %}
                </div>
            </div>

        {% elif key == 'prestige' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9813;</div>
                <h3>Prestige is Coming</h3>
                <p>Competitive ranking and progression features are on the way.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>ELO title ranks and ranked ladders</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>High-stakes H2H rooms</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Elite-only contests</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Seasonal Battle Pass with tier progression</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Exclusive cosmetics and profile flairs</span>
                    </div>
                </div>
            </div>

        {% elif key == 'access' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9881;</div>
                <h3>Access is Coming</h3>
                <p>Strategic tools and visualizations that sharpen your edge â€” without breaking competitive integrity.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Advanced matchup visualizations</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Archetype heatmaps</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Opponent scouting reports</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Historical matchup explorer</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Ceiling probability charts</span>
                    </div>
                </div>
            </div>

        {% elif key == 'analytics' %}
            <div class="coming-soon-panel">
                <div class="coming-soon-icon">&#9783;</div>
                <h3>Analytics is Coming</h3>
                <p>Lineup customization features that let you build your way.</p>
                <div class="roadmap-list">
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom lineup naming</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Save lineup templates</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Advanced optimizer presets</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom projection weight uploads</span>
                    </div>
                    <div class="roadmap-item">
                        <span class="roadmap-dot"></span>
                        <span>Custom DVS weighting sliders</span>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="shop-preview-overlay" id="previewOverlay">
    <div class="shop-preview-modal">
        <button class="shop-preview-close" id="previewClose">&times;</button>
        <div class="shop-preview-content" id="previewContent"></div>
        <div class="shop-preview-info">
            <h2 id="previewName"></h2>
            <p id="previewDesc"></p>
            <p class="price" id="previewPrice"></p>
            <div id="previewAction"></div>
        </div>
    </div>
</div>

<script>
(function() {
    var username = {{ user.username|tojson }};

    document.querySelectorAll('.shop-item[data-category="theme"]').forEach(function(el) {
        var swatch = el.querySelector('.theme-swatch');
        if (!swatch) return;
        try {
            var d = JSON.parse(el.dataset.itemData);
            swatch.style.background = d.bg || '#1a1a1a';
            swatch.style.borderLeft = '4px solid ' + (d.accent || '#fff');
            swatch.style.position = 'relative';
            swatch.innerHTML = '<span style="position:absolute;top:8px;left:12px;font-size:0.7rem;font-weight:700;color:' + (d.text || '#fff') + ';letter-spacing:0.05em;">THEME</span>' +
                '<span style="position:absolute;bottom:8px;right:12px;width:20px;height:20px;border-radius:50%;background:' + (d.accent || '#fff') + ';box-shadow:0 0 8px ' + (d.glow || 'transparent') + ';"></span>';
        } catch(e) {}
    });

    document.querySelectorAll('.shop-item[data-category="badge"]').forEach(function(el) {
        var preview = el.querySelector('.badge-preview-card');
        if (!preview) return;
        try {
            var d = JSON.parse(el.dataset.itemData);
            if (d.type === 'signature') {
                preview.innerHTML = '<span style="font-weight:700;font-size:1rem;color:' + (d.color || '#1a1a1a') + ';letter-spacing:0.1em;' + (d.animated ? 'animation:pulse-glow 2s ease-in-out infinite;' : '') + '">' + (d.text || '') + '</span>';
            } else if (d.type === 'frame_accent') {
                preview.style.border = '3px solid ' + (d.color || '#D4AF37');
                if (d.animated) preview.style.boxShadow = '0 0 10px ' + (d.color || '#D4AF37');
                preview.innerHTML = '<span style="font-size:0.7rem;color:' + (d.color || '#1a1a1a') + ';font-weight:600;text-transform:uppercase;">' + (d.style || 'accent') + '</span>';
            } else if (d.type === 'divider') {
                preview.innerHTML = '<div style="width:80%;height:2px;background:' + (d.color || '#1a1a1a') + ';margin:auto;border-radius:2px;"></div>';
            } else if (d.type === 'aura') {
                preview.style.boxShadow = '0 0 15px ' + (d.color || '#f97316') + ', 0 0 30px ' + (d.color || '#f97316') + '40';
                preview.innerHTML = '<span style="font-size:0.7rem;color:' + (d.color || '#f97316') + ';font-weight:600;">AURA</span>';
            }
        } catch(e) {}
    });

    document.querySelectorAll('.pillar-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.pillar-tab').forEach(function(t) { t.classList.remove('active'); });
            document.querySelectorAll('.pillar-panel').forEach(function(p) { p.classList.remove('active'); });
            tab.classList.add('active');
            document.getElementById('pillar-' + tab.dataset.pillar).classList.add('active');
        });
    });

    var overlay = document.getElementById('previewOverlay');
    var content = document.getElementById('previewContent');
    var nameEl = document.getElementById('previewName');
    var descEl = document.getElementById('previewDesc');
    var priceEl = document.getElementById('previewPrice');
    var actionEl = document.getElementById('previewAction');

    function openPreview(el) {
        var d = el.closest('.shop-item').dataset;
        var category = d.category;
        var name = d.name;
        var rawData = d.itemData;
        var description = d.description;
        var price = d.price;
        var itemId = d.itemId;
        var owned = d.owned === 'true';
        var canAfford = d.canAfford === 'true';
        var equipped = d.equipped === 'true';
        var rarity = d.rarity || 'common';

        nameEl.textContent = name;
        descEl.textContent = description;
        priceEl.textContent = price + ' Coach Coin';
        content.innerHTML = '';

        if (category === 'avatar') {
            var card = document.createElement('div');
            card.className = 'preview-profile-card';
            var wrap = document.createElement('div');
            wrap.className = 'preview-avatar-wrap';
            var img = document.createElement('img');
            img.src = rawData;
            img.alt = name;
            wrap.appendChild(img);
            var info = document.createElement('div');
            info.className = 'preview-profile-info';
            var uname = document.createElement('span');
            uname.className = 'preview-username';
            uname.textContent = username;
            var label = document.createElement('span');
            label.className = 'preview-label';
            label.textContent = 'How this avatar looks on your profile';
            info.appendChild(uname);
            info.appendChild(label);
            card.appendChild(wrap);
            card.appendChild(info);
            content.appendChild(card);

        } else if (category === 'theme') {
            try {
                var t = JSON.parse(rawData);
            } catch(e) { var t = {}; }
            var mock = document.createElement('div');
            mock.className = 'preview-theme-mockup';
            mock.style.cssText = 'background:' + (t.bg||'#1a1a1a') + ';border-radius:12px;padding:24px;min-height:260px;position:relative;overflow:hidden;';

            var headerBar = document.createElement('div');
            headerBar.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:20px;';
            var avatarCircle = document.createElement('div');
            avatarCircle.style.cssText = 'width:56px;height:56px;border-radius:50%;background:' + (t.card_bg||'#333') + ';border:3px solid ' + (t.accent||'#fff') + ';box-shadow:0 0 16px ' + (t.glow||'transparent') + ';display:flex;align-items:center;justify-content:center;font-size:1.4rem;color:' + (t.text||'#fff') + ';';
            avatarCircle.textContent = username.charAt(0).toUpperCase();
            var headerInfo = document.createElement('div');
            headerInfo.innerHTML = '<div style="font-weight:700;font-size:1.1rem;color:' + (t.text||'#fff') + ';">' + username + '</div>' +
                '<div style="font-size:0.75rem;color:' + (t.accent||'#aaa') + ';font-weight:600;letter-spacing:0.05em;text-transform:uppercase;">' + name + '</div>';
            headerBar.appendChild(avatarCircle);
            headerBar.appendChild(headerInfo);
            mock.appendChild(headerBar);

            var statsRow = document.createElement('div');
            statsRow.style.cssText = 'display:flex;gap:12px;margin-bottom:16px;';
            var statLabels = ['Entries', 'Wins', 'Win Rate'];
            var statValues = ['24', '18', '75%'];
            for (var i = 0; i < 3; i++) {
                var statBox = document.createElement('div');
                statBox.style.cssText = 'flex:1;background:' + (t.card_bg||'#333') + ';border:1px solid ' + (t.border||'#444') + ';border-radius:8px;padding:10px;text-align:center;';
                statBox.innerHTML = '<div style="font-size:1.2rem;font-weight:700;color:' + (t.text||'#fff') + ';">' + statValues[i] + '</div>' +
                    '<div style="font-size:0.65rem;color:' + (t.accent||'#aaa') + ';text-transform:uppercase;letter-spacing:0.05em;font-weight:600;">' + statLabels[i] + '</div>';
                statsRow.appendChild(statBox);
            }
            mock.appendChild(statsRow);

            var rankCard = document.createElement('div');
            rankCard.style.cssText = 'background:' + (t.card_bg||'#333') + ';border:1px solid ' + (t.border||'#444') + ';border-radius:8px;padding:12px;';
            rankCard.innerHTML = '<div style="font-size:0.7rem;color:' + (t.accent||'#aaa') + ';text-transform:uppercase;letter-spacing:0.08em;font-weight:700;margin-bottom:6px;">Competitive Rank</div>' +
                '<div style="display:inline-block;padding:4px 14px;border:2px solid ' + (t.accent||'#aaa') + ';border-radius:16px;color:' + (t.accent||'#aaa') + ';font-weight:700;font-size:0.9rem;">Gold I</div>' +
                '<span style="margin-left:8px;font-size:0.8rem;color:' + (t.text||'#fff') + '50;">1250 MMR</span>';
            mock.appendChild(rankCard);

            var hint = document.createElement('div');
            hint.style.cssText = 'text-align:center;margin-top:16px;font-size:0.75rem;color:' + (t.text||'#fff') + '80;';
            hint.textContent = 'Preview of how your profile page will look with this theme';
            mock.appendChild(hint);

            content.appendChild(mock);

        } else if (category === 'badge') {
            try {
                var b = JSON.parse(rawData);
            } catch(e) { var b = {}; }

            var badgeMock = document.createElement('div');
            badgeMock.style.cssText = 'text-align:center;padding:20px;';

            var bigPreview = document.createElement('div');
            bigPreview.style.cssText = 'width:120px;height:120px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;background:#f9fafb;';
            if (b.type === 'frame_accent') {
                bigPreview.style.border = '4px solid ' + (b.color||'#D4AF37');
                if (b.animated) bigPreview.style.boxShadow = '0 0 20px ' + (b.color||'#D4AF37') + ', 0 0 40px ' + (b.color||'#D4AF37') + '40';
                bigPreview.innerHTML = '<span style="font-size:2rem;color:' + (b.color||'#D4AF37') + ';">&#9733;</span>';
            } else if (b.type === 'signature') {
                bigPreview.style.border = '2px dashed #e5e7eb';
                var sigStyle = 'font-weight:800;font-size:1.3rem;color:' + (b.color||'#1a1a1a') + ';letter-spacing:0.12em;';
                if (b.animated) sigStyle += 'animation:pulse-glow 2s ease-in-out infinite;';
                bigPreview.innerHTML = '<span style="' + sigStyle + '">' + (b.text||'') + '</span>';
            } else if (b.type === 'divider') {
                bigPreview.style.borderRadius = '12px';
                bigPreview.innerHTML = '<div style="width:80%;height:3px;background:' + (b.color||'#1a1a1a') + ';border-radius:4px;"></div>';
            } else if (b.type === 'aura') {
                bigPreview.style.boxShadow = '0 0 25px ' + (b.color||'#f97316') + ', 0 0 50px ' + (b.color||'#f97316') + '50';
                bigPreview.innerHTML = '<span style="font-size:2rem;">&#10024;</span>';
            }
            badgeMock.appendChild(bigPreview);

            var profileMock = document.createElement('div');
            profileMock.style.cssText = 'background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:16px;max-width:280px;margin:0 auto;text-align:left;';
            var mockHeader = '<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">' +
                '<div style="width:36px;height:36px;border-radius:50%;background:#e5e7eb;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;">' + username.charAt(0).toUpperCase() + '</div>' +
                '<div><div style="font-weight:700;font-size:0.95rem;">' + username + '</div>';
            if (b.type === 'signature') {
                var tagStyle = 'display:inline-block;padding:1px 6px;border-radius:8px;font-size:0.6rem;font-weight:700;letter-spacing:0.06em;border:1.5px solid ' + (b.color||'#1a1a1a') + ';color:' + (b.color||'#1a1a1a') + ';';
                if (b.animated) tagStyle += 'animation:pulse-glow 2s ease-in-out infinite;';
                mockHeader += '<span style="' + tagStyle + '">' + (b.text||'') + '</span>';
            } else {
                var tagStyle2 = 'display:inline-block;padding:1px 6px;border-radius:8px;font-size:0.6rem;font-weight:700;letter-spacing:0.06em;border:1.5px solid ' + (b.color||'#6b7280') + ';color:' + (b.color||'#6b7280') + ';';
                mockHeader += '<span style="' + tagStyle2 + '">' + name + '</span>';
            }
            mockHeader += '</div></div>';
            profileMock.innerHTML = mockHeader +
                '<div style="font-size:0.7rem;color:#6b7280;margin-top:4px;">This is how the badge appears on your profile</div>';
            badgeMock.appendChild(profileMock);

            content.appendChild(badgeMock);
        }

        actionEl.innerHTML = '';
        if (owned && equipped) {
            var eqSpan = document.createElement('span');
            eqSpan.className = 'equipped-badge';
            eqSpan.textContent = 'Currently Equipped';
            actionEl.appendChild(eqSpan);
        } else if (owned) {
            var span = document.createElement('span');
            span.className = 'owned-badge';
            span.textContent = 'You own this';
            actionEl.appendChild(span);
            var eqForm = document.createElement('form');
            eqForm.method = 'POST';
            eqForm.action = '/shop/equip/' + itemId;
            eqForm.style.display = 'inline-block';
            eqForm.style.marginLeft = '8px';
            var eqBtn = document.createElement('button');
            eqBtn.type = 'submit';
            eqBtn.className = 'btn btn-primary btn-small';
            eqBtn.textContent = 'Equip';
            eqForm.appendChild(eqBtn);
            actionEl.appendChild(eqForm);
        } else if (canAfford) {
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/shop/buy/' + itemId;
            var btn = document.createElement('button');
            btn.type = 'submit';
            btn.className = 'btn btn-primary';
            btn.textContent = 'Buy Now';
            form.appendChild(btn);
            actionEl.appendChild(form);
        } else {
            var ins = document.createElement('span');
            ins.className = 'insufficient';
            ins.textContent = 'Not enough coins';
            actionEl.appendChild(ins);
        }

        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closePreview() {
        overlay.classList.remove('active');
        document.body.style.overflow = '';
    }

    document.querySelectorAll('.preview-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { openPreview(this); });
    });

    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closePreview();
    });

    document.getElementById('previewClose').addEventListener('click', closePreview);

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closePreview();
    });
})();
</script>
{% endblock %}
