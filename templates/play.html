{% extends "base.html" %}

{% block title %}Play - PIRTDICA{% endblock %}

{% block content %}
<div class="play-page">
    <div class="play-header">
        <h1>Build Your Lineup</h1>
        <p>Pick 9 players to beat the house. Stay under $60,000.</p>
    </div>
    
    <div class="play-container">
        <div class="lineup-side">
            <div class="salary-bar">
                <div class="salary-info">
                    <span class="salary-label">SALARY</span>
                    <span id="salary-display" class="salary-amount">$0 / $60,000</span>
                </div>
                <div class="salary-progress-track">
                    <div id="salary-progress" class="salary-progress-fill" style="width: 0%"></div>
                </div>
                <div class="salary-info">
                    <span class="salary-label">REMAINING</span>
                    <span id="salary-remaining" class="salary-remaining">$60,000</span>
                </div>
            </div>

            <div class="roster-slots">
                <h3>YOUR ROSTER</h3>
                <div id="roster-grid" class="roster-grid">
                    <div class="roster-slot" data-slot="PG1" data-pos="PG">
                        <span class="slot-label">PG</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="PG2" data-pos="PG">
                        <span class="slot-label">PG</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="SG1" data-pos="SG">
                        <span class="slot-label">SG</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="SG2" data-pos="SG">
                        <span class="slot-label">SG</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="SF1" data-pos="SF">
                        <span class="slot-label">SF</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="SF2" data-pos="SF">
                        <span class="slot-label">SF</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="PF1" data-pos="PF">
                        <span class="slot-label">PF</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="PF2" data-pos="PF">
                        <span class="slot-label">PF</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                    <div class="roster-slot" data-slot="C1" data-pos="C">
                        <span class="slot-label">C</span>
                        <span class="slot-empty">Select Player</span>
                    </div>
                </div>
                <div class="roster-summary">
                    <div class="summary-row">
                        <span>Projected FP</span>
                        <span id="total-proj" class="summary-value">0.0</span>
                    </div>
                </div>
            </div>

            <form method="POST" action="/submit-lineup" id="lineup-form">
                <div id="hidden-inputs"></div>
                <button type="submit" class="btn btn-primary btn-full" id="submit-btn" disabled>
                    Submit Lineup (0/9)
                </button>
            </form>

            <div class="house-preview">
                <h3>House Score to Beat</h3>
                <div class="house-score">
                    <span class="proj">{{ "%.1f"|format(house_proj_total) }} Proj FP</span>
                </div>
                <p class="house-hint-small">Use PIRTDICA's research tools to build a lineup that beats the house!</p>
            </div>
        </div>

        <div class="player-pool-side">
            <div class="pool-header">
                <h3>PLAYER POOL</h3>
                <div class="pool-filters">
                    <input type="text" id="search" class="pool-search" placeholder="Search players...">
                    <select id="pos-filter" class="pool-select">
                        <option value="">All Positions</option>
                        <option value="PG">PG</option>
                        <option value="SG">SG</option>
                        <option value="SF">SF</option>
                        <option value="PF">PF</option>
                        <option value="C">C</option>
                    </select>
                    <select id="status-filter" class="pool-select">
                        <option value="">All Status</option>
                        <option value="healthy">Healthy</option>
                        <option value="PROBABLE">Probable</option>
                        <option value="QUESTIONABLE">Questionable</option>
                        <option value="GTD">GTD</option>
                        <option value="DOUBTFUL">Doubtful</option>
                        <option value="OUT">Out</option>
                    </select>
                </div>
            </div>
            <div class="pool-table-wrapper">
                <table class="player-table" id="player-table">
                    <thead>
                        <tr>
                            <th class="col-action"></th>
                            <th class="col-pos">Pos</th>
                            <th class="col-name">Player</th>
                            <th class="col-status">Status</th>
                            <th class="col-matchup">Matchup</th>
                            <th class="col-salary" data-sort="number">Salary</th>
                            <th class="col-proj" data-sort="number">Proj</th>
                            <th class="col-value" data-sort="number">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in players %}
                        <tr data-name="{{ p.player_name }}" 
                            data-pos="{{ p.fd_position }}" 
                            data-salary="{{ p.salary }}" 
                            data-proj="{{ p.proj_fp }}"
                            data-team="{{ p.team }}" 
                            data-opponent="{{ p.opponent|default('') }}"
                            data-injury="{{ p.injury_status|default('') }}"
                            data-locked="{{ p.is_locked|default(false)|lower }}"
                            data-game-time="{{ p.game_time|default('') }}"
                            data-headshot="{{ headshots.get(p.player_name, '') }}"
                            class="{% if p.is_locked %}locked{% endif %} {% if p.injury_status == 'OUT' %}player-out{% endif %}">
                            <td class="col-action">
                                {% if p.is_locked %}
                                <span class="lock-icon" title="Game started">&#128274;</span>
                                {% else %}
                                <button type="button" class="add-btn" onclick="addPlayerToNextSlot(this)" title="Add player">+</button>
                                {% endif %}
                            </td>
                            <td class="col-pos"><span class="pos-badge">{{ p.fd_position }}</span></td>
                            <td class="col-name">
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <img src="{{ headshots.get(p.player_name, '') }}" alt="" style="width: 32px; height: 32px; border-radius: 0; object-fit: contain; flex-shrink: 0; mix-blend-mode: multiply;" onerror="this.style.display='none'">
                                    <span class="player-name-link" onclick="openShotChart('{{ p.player_name }}', event)" title="View shot chart">{{ p.player_name }}</span>
                                </div>
                            </td>
                            <td class="col-status">
                                {% if p.injury_status == 'OUT' %}
                                <span class="injury-tag tag-out">OUT</span>
                                {% elif p.injury_status == 'DOUBTFUL' %}
                                <span class="injury-tag tag-doubtful">DTD</span>
                                {% elif p.injury_status == 'QUESTIONABLE' %}
                                <span class="injury-tag tag-questionable">Q</span>
                                {% elif p.injury_status == 'GTD' %}
                                <span class="injury-tag tag-gtd">GTD</span>
                                {% elif p.injury_status == 'PROBABLE' %}
                                <span class="injury-tag tag-probable">P</span>
                                {% endif %}
                            </td>
                            <td class="col-matchup">
                                <span class="matchup-text">{{ p.team }} <span class="matchup-vs">vs</span> {{ p.opponent|default('') }}</span>
                                <span class="game-time-small">{{ p.game_time|default('') }}</span>
                            </td>
                            <td class="col-salary">${{ "{:,}".format(p.salary|int) }}</td>
                            <td class="col-proj">{{ "%.1f"|format(p.proj_fp) }}</td>
                            <td class="col-value">{{ "%.1f"|format(p.proj_fp / (p.salary / 1000)) }}x</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="shot-chart-modal" class="sc-modal-overlay" style="display:none;" onclick="if(event.target===this)closeShotChart()">
    <div class="sc-modal">
        <button class="sc-close" onclick="closeShotChart()">&times;</button>
        <div class="sc-header">
            <div class="sc-player-info">
                <h2 id="sc-player-name"></h2>
                <span id="sc-archetype-badge" class="sc-archetype"></span>
                <span id="sc-total-fga" class="sc-fga-count"></span>
            </div>
            <div class="sc-legend">
                <span class="sc-leg-item"><span class="sc-leg-dot" style="background:#d72638"></span> More shots than league avg</span>
                <span class="sc-leg-item"><span class="sc-leg-dot" style="background:#1e3a8a"></span> Fewer shots than league avg</span>
            </div>
        </div>
        <div class="sc-body">
            <div class="sc-canvas-wrap">
                <canvas id="shot-chart-canvas" width="500" height="470"></canvas>
            </div>
            <div class="sc-zone-stats" id="sc-zone-stats"></div>
        </div>
        <div id="sc-loading" class="sc-loading">Loading shot chart...</div>
    </div>
</div>

<style>
.player-name-link { cursor: pointer; text-decoration: underline; text-decoration-color: rgba(0,0,0,0.15); text-underline-offset: 2px; transition: color 0.15s; }
.player-name-link:hover { color: #1e3a8a; text-decoration-color: #1e3a8a; }
.sc-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
.sc-modal { background: #fff; border-radius: 12px; max-width: 600px; width: 95%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.sc-close { position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #6b7280; z-index: 10; line-height: 1; }
.sc-close:hover { color: #111; }
.sc-header { padding: 20px 24px 12px; border-bottom: 1px solid #e5e7eb; }
.sc-player-info { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
.sc-player-info h2 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: -0.01em; }
.sc-archetype { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 2px 8px; border-radius: 4px; background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
.sc-fga-count { font-size: 0.8rem; color: #6b7280; font-weight: 600; }
.sc-legend { display: flex; gap: 16px; margin-top: 8px; flex-wrap: wrap; }
.sc-leg-item { font-size: 0.72rem; color: #6b7280; display: flex; align-items: center; gap: 4px; }
.sc-leg-dot { width: 10px; height: 10px; border-radius: 2px; display: inline-block; }
.sc-body { padding: 16px 24px 20px; }
.sc-canvas-wrap { display: flex; justify-content: center; }
#shot-chart-canvas { max-width: 100%; height: auto; }
.sc-zone-stats { margin-top: 12px; }
.sc-zone-stats table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.sc-zone-stats th { text-align: left; font-weight: 700; text-transform: uppercase; font-size: 0.68rem; letter-spacing: 0.05em; color: #6b7280; padding: 4px 6px; border-bottom: 1px solid #e5e7eb; }
.sc-zone-stats td { padding: 4px 6px; border-bottom: 1px solid #f3f4f6; }
.sc-zone-stats .freq-diff-pos { color: #d72638; font-weight: 700; }
.sc-zone-stats .freq-diff-neg { color: #1e3a8a; font-weight: 700; }
.sc-loading { text-align: center; padding: 60px 20px; color: #888; font-size: 1rem; }
@media (max-width: 600px) {
    .sc-modal { max-width: 100%; border-radius: 8px; }
    .sc-header { padding: 14px 16px 8px; }
    .sc-body { padding: 10px 12px 16px; }
    .sc-player-info h2 { font-size: 1.1rem; }
}
</style>

<script>
const SALARY_CAP = 60000;
const MAX_PLAYERS = 9;

const POSITION_SLOTS = [
    {id: 'PG1', pos: 'PG'}, {id: 'PG2', pos: 'PG'},
    {id: 'SG1', pos: 'SG'}, {id: 'SG2', pos: 'SG'},
    {id: 'SF1', pos: 'SF'}, {id: 'SF2', pos: 'SF'},
    {id: 'PF1', pos: 'PF'}, {id: 'PF2', pos: 'PF'},
    {id: 'C1', pos: 'C'}
];

let roster = {};
let activeSlotId = null;

function canFitPosition(playerPos, slotPos) {
    if (playerPos === slotPos) return true;
    const parts = playerPos.split('/');
    return parts.includes(slotPos);
}

function getEligibleSlots(playerPos) {
    return POSITION_SLOTS.filter(slot => !roster[slot.id] && canFitPosition(playerPos, slot.pos));
}

function findBestSlot(playerPos) {
    const eligible = getEligibleSlots(playerPos);
    if (eligible.length === 0) return null;
    const parts = playerPos.split('/');
    if (parts.length === 1) {
        return eligible[0];
    }
    const primary = eligible.find(s => s.pos === parts[0]);
    return primary || eligible[0];
}

const _coinSound = new Audio('/static/sounds/coin-clink.mp3');
_coinSound.volume = 0.5;
function playCoinSound() {
    _coinSound.currentTime = 0;
    _coinSound.play().catch(() => {});
}

function selectSlot(slotId) {
    const slotData = POSITION_SLOTS.find(s => s.id === slotId);
    if (!slotData) return;
    if (roster[slotId]) return;

    if (activeSlotId === slotId) {
        clearActiveSlot();
        return;
    }

    activeSlotId = slotId;

    document.querySelectorAll('.roster-slot').forEach(el => el.classList.remove('active-slot'));
    const slotEl = document.querySelector(`.roster-slot[data-slot="${slotId}"]`);
    if (slotEl) slotEl.classList.add('active-slot');

    document.getElementById('pos-filter').value = '';
    filterPlayersForSlot(slotData.pos);

    const poolHeader = document.querySelector('.pool-header h3');
    if (poolHeader) poolHeader.textContent = `PLAYER POOL â€” ${slotData.pos}`;
}

function clearActiveSlot() {
    activeSlotId = null;
    document.querySelectorAll('.roster-slot').forEach(el => el.classList.remove('active-slot'));
    filterPlayers();

    const poolHeader = document.querySelector('.pool-header h3');
    if (poolHeader) poolHeader.textContent = 'PLAYER POOL';
}

function filterPlayersForSlot(slotPos) {
    const search = document.getElementById('search').value.toLowerCase();
    const status = document.getElementById('status-filter').value;

    document.querySelectorAll('#player-table tbody tr').forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const playerPos = row.dataset.pos;
        const injury = row.dataset.injury || '';

        const matchSearch = name.includes(search);
        const matchPos = canFitPosition(playerPos, slotPos);

        let matchStatus = true;
        if (status === 'healthy') matchStatus = !injury || injury === '';
        else if (status) matchStatus = injury === status;

        row.style.display = (matchSearch && matchPos && matchStatus) ? '' : 'none';
    });
}

function addPlayerToNextSlot(btn) {
    const row = btn.closest('tr');
    const player = {
        name: row.dataset.name,
        pos: row.dataset.pos,
        team: row.dataset.team,
        salary: parseInt(row.dataset.salary),
        proj: parseFloat(row.dataset.proj),
        injury: row.dataset.injury,
        headshot: row.dataset.headshot
    };

    if (Object.keys(roster).length >= MAX_PLAYERS) {
        showToast('Lineup full! Remove a player first.');
        return;
    }

    if (Object.values(roster).some(p => p && p.name === player.name)) {
        showToast('Player already in lineup');
        return;
    }

    const newSalary = getTotalSalary() + player.salary;
    if (newSalary > SALARY_CAP) {
        showToast('Not enough salary remaining');
        return;
    }

    let targetSlot = null;

    if (activeSlotId && !roster[activeSlotId]) {
        const slotData = POSITION_SLOTS.find(s => s.id === activeSlotId);
        if (slotData && canFitPosition(player.pos, slotData.pos)) {
            targetSlot = slotData;
        }
    }

    if (!targetSlot) {
        targetSlot = findBestSlot(player.pos);
    }

    if (!targetSlot) {
        showToast('No eligible position slot available for ' + player.pos);
        return;
    }

    roster[targetSlot.id] = player;
    row.classList.add('selected');
    btn.disabled = true;
    btn.textContent = '-';
    btn.classList.add('remove-mode');
    btn.onclick = function() { removePlayerFromRoster(player.name); };
    playCoinSound();

    if (activeSlotId) {
        const nextEmpty = POSITION_SLOTS.find(s => !roster[s.id] && s.id !== targetSlot.id);
        if (nextEmpty) {
            selectSlot(nextEmpty.id);
        } else {
            clearActiveSlot();
        }
    }

    updateDisplay();
}

function addPlayerToSlot(slotId, playerName) {
    const row = document.querySelector(`tr[data-name="${playerName}"]`);
    if (!row) return;

    const player = {
        name: row.dataset.name,
        pos: row.dataset.pos,
        team: row.dataset.team,
        salary: parseInt(row.dataset.salary),
        proj: parseFloat(row.dataset.proj),
        injury: row.dataset.injury,
        headshot: row.dataset.headshot
    };

    const newSalary = getTotalSalary() + player.salary;
    if (newSalary > SALARY_CAP) {
        showToast('Not enough salary remaining');
        return;
    }

    roster[slotId] = player;
    row.classList.add('selected');
    const btn = row.querySelector('.add-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = '-';
        btn.classList.add('remove-mode');
        btn.onclick = function() { removePlayerFromRoster(player.name); };
    }
    playCoinSound();
    updateDisplay();
}

function removePlayerFromRoster(playerName) {
    for (const slotId in roster) {
        if (roster[slotId] && roster[slotId].name === playerName) {
            delete roster[slotId];
            break;
        }
    }

    const row = document.querySelector(`tr[data-name="${playerName}"]`);
    if (row) {
        row.classList.remove('selected');
        const btn = row.querySelector('.add-btn, .remove-mode');
        if (btn) {
            btn.disabled = false;
            btn.textContent = '+';
            btn.classList.remove('remove-mode');
            btn.onclick = function() { addPlayerToNextSlot(this); };
        }
    }

    if (activeSlotId) {
        const slotData = POSITION_SLOTS.find(s => s.id === activeSlotId);
        if (slotData) filterPlayersForSlot(slotData.pos);
    }

    updateDisplay();
}

function removeFromSlot(slotId) {
    const player = roster[slotId];
    if (player) {
        removePlayerFromRoster(player.name);
    }
}

function getTotalSalary() {
    return Object.values(roster).reduce((sum, p) => p ? sum + p.salary : sum, 0);
}

function getTotalProj() {
    return Object.values(roster).reduce((sum, p) => p ? sum + p.proj : sum, 0);
}

function getPlayerCount() {
    return Object.values(roster).filter(p => p).length;
}

function updateDisplay() {
    const totalSalary = getTotalSalary();
    const totalProj = getTotalProj();
    const count = getPlayerCount();
    const remaining = SALARY_CAP - totalSalary;
    const pct = (totalSalary / SALARY_CAP) * 100;

    document.getElementById('salary-display').textContent = '$' + totalSalary.toLocaleString() + ' / $60,000';
    document.getElementById('salary-remaining').textContent = '$' + remaining.toLocaleString();
    document.getElementById('salary-remaining').className = 'salary-remaining' + (remaining < 0 ? ' over-cap' : '');
    document.getElementById('total-proj').textContent = totalProj.toFixed(1);

    const progressBar = document.getElementById('salary-progress');
    progressBar.style.width = Math.min(pct, 100) + '%';
    progressBar.className = 'salary-progress-fill' + (pct > 100 ? ' over' : pct > 90 ? ' warning' : '');

    POSITION_SLOTS.forEach(slot => {
        const el = document.querySelector(`.roster-slot[data-slot="${slot.id}"]`);
        if (!el) return;
        const player = roster[slot.id];

        if (player) {
            el.innerHTML = `
                <span class="slot-label">${slot.pos}</span>
                <div class="slot-filled" style="display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0;">
                    ${player.headshot ? `<img src="${player.headshot}" alt="" style="width: 28px; height: 28px; border-radius: 0; object-fit: contain; flex-shrink: 0; mix-blend-mode: multiply;" onerror="this.style.display='none'">` : ''}
                    <span class="slot-player-name">${player.name}</span>
                    <span class="slot-player-info">
                        ${player.injury ? '<span class="injury-tag tag-' + player.injury.toLowerCase() + '">' + player.injury + '</span>' : ''}
                        $${player.salary.toLocaleString()} | ${player.proj.toFixed(1)} FP
                    </span>
                </div>
                <button type="button" class="slot-remove" onclick="event.stopPropagation(); removeFromSlot('${slot.id}')">x</button>
            `;
            el.classList.add('filled');
            el.classList.remove('active-slot');
            el.onclick = null;
        } else {
            el.innerHTML = `
                <span class="slot-label">${slot.pos}</span>
                <span class="slot-empty">Select Player</span>
            `;
            el.classList.remove('filled');
            el.onclick = function() { selectSlot(slot.id); };
        }

        if (activeSlotId === slot.id && !player) {
            el.classList.add('active-slot');
        }
    });

    const hiddenInputs = document.getElementById('hidden-inputs');
    hiddenInputs.innerHTML = Object.values(roster)
        .filter(p => p)
        .map(p => `<input type="hidden" name="players" value="${p.name}">`)
        .join('');

    const submitBtn = document.getElementById('submit-btn');
    submitBtn.textContent = `Submit Lineup (${count}/${MAX_PLAYERS})`;
    submitBtn.disabled = count !== MAX_PLAYERS;
}

function showToast(msg) {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast';
        document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
}

document.getElementById('search').addEventListener('input', function() {
    if (activeSlotId) {
        const slotData = POSITION_SLOTS.find(s => s.id === activeSlotId);
        if (slotData) filterPlayersForSlot(slotData.pos);
    } else {
        filterPlayers();
    }
});
document.getElementById('pos-filter').addEventListener('change', function() {
    if (activeSlotId) clearActiveSlot();
    filterPlayers();
});
document.getElementById('status-filter').addEventListener('change', function() {
    if (activeSlotId) {
        const slotData = POSITION_SLOTS.find(s => s.id === activeSlotId);
        if (slotData) filterPlayersForSlot(slotData.pos);
    } else {
        filterPlayers();
    }
});

function filterPlayers() {
    const search = document.getElementById('search').value.toLowerCase();
    const pos = document.getElementById('pos-filter').value;
    const status = document.getElementById('status-filter').value;

    document.querySelectorAll('#player-table tbody tr').forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const playerPos = row.dataset.pos;
        const injury = row.dataset.injury || '';

        const matchSearch = name.includes(search);
        const matchPos = !pos || playerPos.includes(pos);

        let matchStatus = true;
        if (status === 'healthy') matchStatus = !injury || injury === '';
        else if (status) matchStatus = injury === status;

        row.style.display = (matchSearch && matchPos && matchStatus) ? '' : 'none';
    });
}

document.querySelectorAll('#player-table th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
        const table = document.getElementById('player-table');
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const colIdx = th.cellIndex;
        const isNumber = th.dataset.sort === 'number';
        const isAsc = th.classList.contains('sort-asc');

        document.querySelectorAll('#player-table th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
        th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');

        rows.sort((a, b) => {
            let va = a.cells[colIdx].textContent.replace(/[$,x]/g, '').trim();
            let vb = b.cells[colIdx].textContent.replace(/[$,x]/g, '').trim();
            if (isNumber) { va = parseFloat(va) || 0; vb = parseFloat(vb) || 0; }
            if (va < vb) return isAsc ? 1 : -1;
            if (va > vb) return isAsc ? -1 : 1;
            return 0;
        });

        rows.forEach(r => tbody.appendChild(r));
    });
});

updateDisplay();

function openShotChart(playerName, evt) {
    if (evt) evt.stopPropagation();
    var modal = document.getElementById('shot-chart-modal');
    var loading = document.getElementById('sc-loading');
    var canvas = document.getElementById('shot-chart-canvas');
    var body = document.querySelector('.sc-body');
    modal.style.display = 'flex';
    body.style.display = 'none';
    loading.style.display = 'block';
    document.getElementById('sc-player-name').textContent = playerName;
    document.getElementById('sc-archetype-badge').textContent = '';
    document.getElementById('sc-total-fga').textContent = '';
    document.getElementById('sc-zone-stats').innerHTML = '';

    fetch('/api/player-shot-chart/' + encodeURIComponent(playerName))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            loading.style.display = 'none';
            if (data.error || !data.zones || Object.keys(data.zones).length === 0 || data.total_fga === 0) {
                body.style.display = 'block';
                document.getElementById('sc-zone-stats').innerHTML = '<div style="text-align:center;padding:30px;color:#888;">' + (data.error || 'No shot data available') + '</div>';
                return;
            }
            body.style.display = 'block';
            if (data.archetype) document.getElementById('sc-archetype-badge').textContent = data.archetype;
            document.getElementById('sc-total-fga').textContent = data.total_fga + ' FGA';
            renderShotChart(canvas, data);
            renderZoneStats(data);
        })
        .catch(function(e) {
            loading.style.display = 'none';
            body.style.display = 'block';
            document.getElementById('sc-zone-stats').innerHTML = '<div style="text-align:center;padding:30px;color:#888;">Failed to load shot chart</div>';
        });
}

function closeShotChart() {
    document.getElementById('shot-chart-modal').style.display = 'none';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeShotChart();
});

function renderShotChart(canvas, data) {
    var W = 500, H = 470;
    var dpr = window.devicePixelRatio || 1;
    canvas.width = W * dpr;
    canvas.height = H * dpr;
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    var ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.clearRect(0, 0, W, H);

    var S = 9;
    var bx = 250;
    var baseY = 452;
    var by = baseY - Math.round(5.25 * S);

    var RA_R = Math.round(4 * S);
    var LANE_HW = Math.round(8 * S);
    var FT_DIST = Math.round(13.75 * S);
    var FT_R = Math.round(6 * S);
    var THREE_R = Math.round(23.75 * S);
    var THREE_STRAIGHT_X = Math.round(22 * S);
    var COURT_HW = Math.round(25 * S);
    var THREE_ANG = Math.acos(THREE_STRAIGHT_X / THREE_R);
    var CORNER_TOP_Y = by - Math.round(Math.sqrt(THREE_R * THREE_R - THREE_STRAIGHT_X * THREE_STRAIGHT_X));
    var ftLineY = by - FT_DIST;
    var rimR = Math.round(0.75 * S);
    var bbW = Math.round(3 * S);

    ctx.fillStyle = '#fafafa';
    ctx.fillRect(0, 0, W, H);

    var zones = data.zones || {};
    var league = data.league_avg || {};

    function getZoneColor(zoneKey) {
        var pz = zones[zoneKey];
        var lz = league[zoneKey];
        if (!pz || !lz) return 'rgba(200,200,200,0.3)';
        var freqDiff = pz.freq - lz.freq;
        var intensity = Math.min(Math.abs(freqDiff) / 12, 1);
        var alpha = 0.2 + intensity * 0.5;
        if (freqDiff >= 0) {
            var r = Math.round(215 * intensity + 240 * (1 - intensity));
            var g = Math.round(38 * intensity + 200 * (1 - intensity));
            var b = Math.round(56 * intensity + 200 * (1 - intensity));
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha.toFixed(2) + ')';
        } else {
            var r = Math.round(30 * intensity + 200 * (1 - intensity));
            var g = Math.round(58 * intensity + 200 * (1 - intensity));
            var b = Math.round(138 * intensity + 220 * (1 - intensity));
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha.toFixed(2) + ')';
        }
    }

    function drawZoneLabel(cx, cy, zoneKey) {
        var pz = zones[zoneKey];
        if (!pz || pz.fga === 0) return;
        ctx.fillStyle = '#111';
        ctx.font = 'bold 13px system-ui, sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(pz.fg_pct + '%', cx, cy - 8);
        ctx.font = '10px system-ui, sans-serif';
        ctx.fillStyle = '#555';
        ctx.fillText(pz.fga + ' FGA', cx, cy + 8);
        var lz = league[zoneKey];
        if (lz) {
            var diff = pz.freq - lz.freq;
            ctx.font = 'bold 9px system-ui, sans-serif';
            ctx.fillStyle = diff > 0.5 ? '#d72638' : (diff < -0.5 ? '#1e3a8a' : '#888');
            ctx.fillText((diff > 0 ? '+' : '') + diff.toFixed(1) + '% freq', cx, cy + 22);
        }
    }

    ctx.save();
    ctx.beginPath();
    ctx.rect(bx - COURT_HW, 0, COURT_HW * 2, baseY);
    ctx.clip();

    ctx.fillStyle = getZoneColor('Above Break 3');
    ctx.fillRect(bx - COURT_HW, 0, COURT_HW * 2, baseY);

    ctx.fillStyle = getZoneColor('Corner 3');
    ctx.beginPath();
    ctx.rect(bx - COURT_HW, CORNER_TOP_Y, COURT_HW - THREE_STRAIGHT_X, baseY - CORNER_TOP_Y);
    ctx.fill();
    ctx.beginPath();
    ctx.rect(bx + THREE_STRAIGHT_X, CORNER_TOP_Y, COURT_HW - THREE_STRAIGHT_X, baseY - CORNER_TOP_Y);
    ctx.fill();

    ctx.fillStyle = getZoneColor('Mid-Range');
    ctx.beginPath();
    ctx.moveTo(bx - THREE_STRAIGHT_X, baseY);
    ctx.lineTo(bx - THREE_STRAIGHT_X, CORNER_TOP_Y);
    ctx.arc(bx, by, THREE_R, Math.PI + THREE_ANG, Math.PI * 2 - THREE_ANG);
    ctx.lineTo(bx + THREE_STRAIGHT_X, baseY);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = getZoneColor('Paint (Non-RA)');
    ctx.beginPath();
    ctx.rect(bx - LANE_HW, ftLineY, LANE_HW * 2, baseY - ftLineY);
    ctx.fill();

    ctx.fillStyle = getZoneColor('Restricted Area');
    ctx.beginPath();
    ctx.arc(bx, by, RA_R, Math.PI, Math.PI * 2);
    ctx.closePath();
    ctx.fill();

    ctx.restore();

    ctx.strokeStyle = '#444';
    ctx.lineWidth = 1.5;

    ctx.beginPath();
    ctx.moveTo(bx - COURT_HW, baseY);
    ctx.lineTo(bx + COURT_HW, baseY);
    ctx.stroke();

    ctx.beginPath();
    ctx.rect(bx - COURT_HW, baseY - Math.round(47 * S), COURT_HW * 2, Math.round(47 * S));
    ctx.stroke();

    ctx.beginPath();
    ctx.rect(bx - LANE_HW, ftLineY, LANE_HW * 2, baseY - ftLineY);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(bx, ftLineY, FT_R, Math.PI, Math.PI * 2);
    ctx.stroke();

    ctx.setLineDash([5, 5]);
    ctx.beginPath();
    ctx.arc(bx, ftLineY, FT_R, 0, Math.PI);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.beginPath();
    ctx.arc(bx, by, RA_R, Math.PI, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(bx - THREE_STRAIGHT_X, baseY);
    ctx.lineTo(bx - THREE_STRAIGHT_X, CORNER_TOP_Y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(bx + THREE_STRAIGHT_X, baseY);
    ctx.lineTo(bx + THREE_STRAIGHT_X, CORNER_TOP_Y);
    ctx.stroke();

    ctx.beginPath();
    ctx.arc(bx, by, THREE_R, Math.PI + THREE_ANG, Math.PI * 2 - THREE_ANG);
    ctx.stroke();

    ctx.strokeStyle = '#333';
    ctx.beginPath();
    ctx.arc(bx, by, rimR, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(bx - bbW, baseY - Math.round(4 * S));
    ctx.lineTo(bx + bbW, baseY - Math.round(4 * S));
    ctx.stroke();

    var mcY = baseY - Math.round(47 * S);
    ctx.beginPath();
    ctx.arc(bx, mcY, Math.round(2 * S), 0, Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(bx, mcY, Math.round(6 * S), 0, Math.PI);
    ctx.stroke();

    drawZoneLabel(bx, by - RA_R / 2 - 5, 'Restricted Area');
    drawZoneLabel(bx, by - RA_R - (FT_DIST - RA_R) / 2, 'Paint (Non-RA)');
    drawZoneLabel(bx - LANE_HW - 55, by - FT_DIST / 2, 'Mid-Range');
    drawZoneLabel(bx, by - THREE_R - 30, 'Above Break 3');
    drawZoneLabel(bx - THREE_STRAIGHT_X - (COURT_HW - THREE_STRAIGHT_X) / 2, by + 10, 'Corner 3');
    drawZoneLabel(bx + THREE_STRAIGHT_X + (COURT_HW - THREE_STRAIGHT_X) / 2, by + 10, 'Corner 3');
}

function renderZoneStats(data) {
    var container = document.getElementById('sc-zone-stats');
    var zones = data.zones || {};
    var league = data.league_avg || {};

    var zoneOrder = ['Restricted Area', 'Paint (Non-RA)', 'Mid-Range', 'Above Break 3', 'Corner 3'];
    var zoneLabels = {
        'Restricted Area': 'Restricted Area',
        'Paint (Non-RA)': 'Paint (Non-RA)',
        'Mid-Range': 'Mid-Range',
        'Above Break 3': 'Above Break 3',
        'Corner 3': 'Corner 3'
    };

    var html = '<table><thead><tr><th>Zone</th><th>FGA</th><th>FGM</th><th>FG%</th><th>Freq%</th><th>vs Avg</th></tr></thead><tbody>';
    for (var i = 0; i < zoneOrder.length; i++) {
        var z = zoneOrder[i];
        var pz = zones[z];
        if (!pz) continue;
        var lz = league[z] || {};
        var leagueFreq = lz.freq || 0;
        var diff = pz.freq - leagueFreq;
        var diffClass = diff > 0.5 ? 'freq-diff-pos' : (diff < -0.5 ? 'freq-diff-neg' : '');
        var diffStr = diff > 0 ? '+' + diff.toFixed(1) + '%' : diff.toFixed(1) + '%';
        html += '<tr>';
        html += '<td>' + (zoneLabels[z] || z) + '</td>';
        html += '<td>' + pz.fga + '</td>';
        html += '<td>' + pz.fgm + '</td>';
        html += '<td>' + pz.fg_pct + '%</td>';
        html += '<td>' + pz.freq + '%</td>';
        html += '<td class="' + diffClass + '">' + diffStr + '</td>';
        html += '</tr>';
    }
    html += '</tbody></table>';
    container.innerHTML = html;
}
</script>
{% endblock %}
